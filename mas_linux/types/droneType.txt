:- write('im sleeping').
:- dynamic dispatcher/1.
:- dynamic state/1.
:- dynamic loc/1.
:- dynamic next_place_tour/2.
:- dynamic drone_position/1.

loc(base).
loc(via_roma).
loc(via_nazionale).
loc(via_garibaldi).
loc(via_verdi).
loc(via_manzoni).
loc(via_dante).
loc(via_marconi).
loc(via_mazzini).
loc(via_cavour).
loc(via_vittorio_emanuele).

next_place_tour(base, via_roma).
next_place_tour(via_roma, via_nazionale).
next_place_tour(via_nazionale, via_garibaldi).
next_place_tour(via_garibaldi, via_verdi).
next_place_tour(via_verdi, via_manzoni).
next_place_tour(via_manzoni, via_dante).
next_place_tour(via_dante, via_marconi).
next_place_tour(via_marconi, via_mazzini).
next_place_tour(via_mazzini, via_cavour).
next_place_tour(via_cavour, via_vittorio_emanuele).
next_place_tour(via_vittorio_emanuele, base).

drone_position(base).
dispatcher(mainDispatcher).
state(pause).

activateE :> 
    retract(state(pause)), 
    assert(state(working)), 
    dispatcher(D),
    messageA(D, send_message(im_active(Me), Me)),
    nl,
    write('sto facendo il tour!').

move_next :- state(working).
move_nextI :> 
    drone_position(L),
    next_place_tour(L, L2),
    nl,
    write('tour: '), write(L), write(' -> '), write(L2),
    gotoA(L2),
    sleep(4).


battery_check :- state(working), random(0, 1000, X), X > 998.
battery_checkI :>
        nl,
        dispatcher(D),
        messageA(D, send_message(im_recharging(Me), Me)),
        retract(state(working)),
        assert(state(pause)),
        gotoA(base),
        write('--- mi sono scaricato ---'),
        rechargeA.



spot_fireE :>
        drone_position(Loc),
        dispatcher(D),
        nl,
        write('!!! incendio trovato !!!'),
        messageA(D, send_message(report_emergency(Loc, fire), Me)).

spot_accidentE :>
        drone_position(Loc),
        dispatcher(D),
        nl,
        write('!!! ferito trovato !!!'),
        messageA(D, send_message(report_emergency(Loc, ambulance), Me)).

request_recognitionE(Loc) :>
        random(0, 100, X),
        loc(Loc),
        gotoA(Loc),
        nl,
        write('Faccio Ricognizione a '),
        write(Loc),
        ricognizioneA(Loc, X).
        
ricognizioneA(Loc, X) :> 
        dispatcher(D),
        X > 70,
        nl,
        write('!!! incendio trovato !!!'),
        messageA(D, send_message(report_emergency(Loc, fire), Me)).

ricognizioneA(Loc, X) :>
        nl,
        X > 29,
        X < 71,
        write('Nessun Problema').

ricognizioneA(Loc, X) :>
        dispatcher(D),
        X < 30,
        nl,
        write('!!! incendio trovato !!!'),
        messageA(D, send_message(report_emergency(Loc, ambulance), Me)).

gotoA(Loc) :> retractall(drone_position(L)), assert(drone_position(Loc)).

rechargeA :> nl, write('--- mi sto ricaricando ---'), sleep(1).