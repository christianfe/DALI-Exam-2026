
:- write('im the ambulance'), nl.

:- dynamic dispatcher/1.
:- dynamic state/1.
:- dynamic ambulance_position/1.
:- dynamic current_job/1.

dispatcher(mainDispatcher).

state(idle).
ambulance_position(base).
current_job(null).

dispatchE(Loc) :>
    state(idle),
    nl, write('[E] dispatch received to '), write(Loc), nl,

    retract(state(idle)),
    assert(state(busy)),
    retract(current_job(null)),
    assert(current_job(Loc)),

    dispatcher(D),
    messageA(D, send_message(ambulance_ack(dispatch,Loc), ambulance)),

    nl, write('[A] going to '), write(Loc), write(' (10s)'), nl,
    gotoA(Loc),
    sleep(10),

    nl, write('[A] rescuing at '), write(Loc), nl,
    rescue_peopleA,
    messageA(D, send_message(report(emergency_retired,Loc), ambulance)),

    nl, write('[A] returning to base'), nl,
    gotoA(base),
    sleep(2),

    retract(state(busy)),
    assert(state(idle)),
    retract(current_job(Loc)),
    assert(current_job(null)),

    nl, write('[A] back to base - idle'), nl,
    messageA(D, send_message(ambulance_status(available), ambulance)).

dispatchE(Loc) :>
    state(busy),
    nl, write('[E] dispatch refused (busy) to '), write(Loc), nl,
    dispatcher(D),
    messageA(D, send_message(dispatch_refused(Loc, reason(busy)), ambulance)).


gotoA(Loc) :>
    retractall(ambulance_position(_)),
    assert(ambulance_position(Loc)).

rescue_peopleA :>
    sleep(2).
