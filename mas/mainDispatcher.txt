:- dynamic drone/1.
:- dynamic next_drone/2.
:- dynamic active_drone/1.
:- dynamic state/1.

:- dynamic ambulance_unit/1.
:- dynamic next_ambulance/2.
:- dynamic dispatched_ambulance/1.
:- dynamic firerescue_unit/1.
:- dynamic next_firerescue/2.
:- dynamic dispatched_firerescue/1.

drone(drone1).
drone(drone2).
next_drone(drone1, drone2).
next_drone(drone2, drone1).
active_drone(null).
state(wakeup).

ambulance_unit(ambulance1).
ambulance_unit(ambulance2).
next_ambulance(null, ambulance1).
next_ambulance(ambulance1, ambulance2).
next_ambulance(ambulance2, ambulance1).

dispatched_ambulance(null).


firerescue_unit(fireRescue1).
firerescue_unit(fireRescue2).
next_firerescue(null, fireRescue1).
next_firerescue(fireRescue1, fireRescue2).
next_firerescue(fireRescue2, fireRescue1).

dispatched_firerescue(null).



turn_on_system(X) :- state(wakeup), random(0, 1000, X).
turn_on_systemI(X) :>
    retract(state(S)), 
    nl,
    X > 500,
    write('[I] faccio partire la perlustrazione!'), write(' seed: '), write(X),
    messageA(drone1, send_message(activate, mainDispatcher)).

turn_on_systemI(X) :> 
    retract(state(S)), 
    nl,
    X < 501,
    write('[I] faccio partire la perlustrazione!'), write(' seed: '), write(X),
    messageA(drone2, send_message(activate, mainDispatcher)).


im_activeE(Drone) :> 
    retract(active_drone(null)),
    assert(active_drone(Drone)), 
    nl,
    write('[I] '), write(Drone),
    write(' attivo').

im_rechargingE(Drone) :>
    nl,
    active_drone(Drone),
    retract(active_drone(Drone)),
    assert(active_drone(null)),
    next_drone(Drone, DroneNext),
    write('[I] '), write(Drone), write(' scarico quindi sostituisco con '),write(DroneNext),
    messageA(DroneNext, send_message(activate, mainDispatcher)).

report_emergencyE(Loc, fire) :>
    nl,
    dispatched_firerescue(F),
    next_firerescue(F, F2),
    retract(dispatched_firerescue(F)),
    assert(dispatched_firerescue(F2)),
    write('[E] !!! incendio segnalato a '), write(Loc),write('!!! Provo a mandare '), write(F2),
    messageA(F2, send_message(dispatch(Loc), mainDispatcher)).

report_emergencyE(Loc, ambulance) :>
    nl,
    dispatched_ambulance(A),
    next_ambulance(A, A2),
    retract(dispatched_ambulance(A)),
    assert(dispatched_ambulance(A2)),
    write('[E] !!! incidente segnalato a '), write(Loc),write('!!! Provo a mandare '), write(A2),
    messageA(A2, send_message(dispatch(Loc), mainDispatcher)).

fireResque_ackE(dispatch, Loc) :>
    nl,
    write('[E] fireResque accetta la chiamata a '), write(Loc).

ambulance_ackE(dispatch, Loc) :>
    nl,
    write('[E] ambulanza accetta la chiamata a '), write(Loc).


reportE(emergency_retired, Loc, Agent) :>
    nl,
    write('[E] emergenza a '), write(Loc), write(' risolta da '), write(Agent).

ambulance_statusE(available, Agent) :>
    nl,
    write('[E] ambulanza '), write(Agent), write(' pronta per nuove chiamate').

fireResque_statusE(available, Agent) :>
    nl,
    write('[E] fireResque '), write(Agent), write(' pronto per nuove chiamate').



dispatch_refusedE(Loc, S, Agent) :>
    nl,
    write('[E] l ambulanza ha rifiutato di andare a '), write(Loc), write(' perche '), write(S),
    ambulance_unit(Agent),
    dispatched_ambulance(A),
    next_ambulance(A, A2),
    retract(dispatched_ambulance(A)),
    assert(dispatched_ambulance(A2)),
    sleep(3),
    write('[I] provo a mandare '), write(A2), write(' a '), write(Loc),
    messageA(A2, send_message(dispatch(Loc), mainDispatcher)).


dispatch_refusedE(Loc, S, Agent) :>
    nl,
    write('[E] il fireResque ha rifiutato di andare a '), write(Loc), write(' perche '), write(S),
    firerescue_unit(Agent),
    dispatched_firerescue(F),
    next_firerescue(F, F2),
    retract(dispatched_firerescue(F)),
    assert(dispatched_firerescue(F2)),
    sleep(3),
    write('[I] provo a mandare '), write(F2), write(' a '), write(Loc),
    messageA(F2, send_message(dispatch(Loc), mainDispatcher)).

call_emergencyE(Loc, null) :> 
    nl,
    write('!!chiamata di emergenza!!: chiedo ricognizione a  '),
    active_drone(Drone),
    messageA(Drone, send_message(request_recognition(Loc), mainDispatcher)),
    write(Drone).
